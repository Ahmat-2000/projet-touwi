<!DOCTYPE html>
<html lang="en">
<head>
    <title>Video and Signal Sync</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Video and Signal Sync Example</h1>

    <video id="syncVideo" width="600" controls>
        <source src="placeholder.webm" type="video/mp4">
    </video>

    <div id="signalPlot" style="width:100%;height:500px;"></div>

    <script>
        // Example accelerometer data (timestamp in Unix time, X-axis values)
        const accelData = [
            {timestamp: 1609459200000, x: 0.01},
            {timestamp: 1609459201000, x: 0.02},
            {timestamp: 1609459202000, x: 0.01},
            {timestamp: 1609459203000, x: 0.00},
            {timestamp: 1609459204000, x: -0.01},
            {timestamp: 1609459205000, x: -0.02},
            {timestamp: 1609459206000, x: 0.01},
            {timestamp: 1609459207000, x: 0.02},
            {timestamp: 1609459208000, x: 0.03},
            {timestamp: 1609459209000, x: 0.02},
            {timestamp: 1609459210000, x: 0.01},
        ];

        // Define when the video starts in Unix time
        const videoStartTimestamp = 1609459200000;
        //const videoStartTimestamp = x[0]
        
        function plotSignal(signalData) {
            const timestamps = signalData.map(point => point.timestamp);
            const xValues = signalData.map(point => point.x);

            const trace = {
                x: timestamps,
                y: xValues,
                mode: 'lines',
                type: 'scatter'
            };

            const layout = {
                title: 'Accelerometer X-axis Signal',
                xaxis: { title: 'Timestamp (Unix Time)' },
                yaxis: { title: 'X Value' }
            };

            Plotly.newPlot('signalPlot', [trace], layout);
        }

        // Plot the signal initially
        plotSignal(accelData);

        // Video element
        const videoElement = document.getElementById('syncVideo');

        // Function to sync the plot to video playback
        function syncPlotToVideo(currentVideoTime) {
            // Convert video time (in seconds) to a Unix timestamp
            const currentTimestamp = videoStartTimestamp + currentVideoTime * 1000;

            // Center the plot around the current timestamp (example: +/- 5 seconds)
            const windowSize = 5000;  // 5 seconds before and after
            const filteredData = accelData.filter(point => 
                point.timestamp >= (currentTimestamp - windowSize) &&
                point.timestamp <= (currentTimestamp + windowSize)
            );

            // Update the Plotly chart with the filtered data
            const update = {
                x: [filteredData.map(point => point.timestamp)],
                y: [filteredData.map(point => point.x)]
            };

            Plotly.restyle('signalPlot', update);
            Plotly.relayout('signalPlot', {
                'xaxis.range': [currentTimestamp - windowSize, currentTimestamp + windowSize]
            });
        }

        // Add event listener for the video timeupdate event
        videoElement.addEventListener('timeupdate', () => {
            const currentVideoTime = videoElement.currentTime;  // Time in seconds
            syncPlotToVideo(currentVideoTime);
        });

        // Add click event listener to sync video with plot
        const signalPlotDiv = document.getElementById('signalPlot');
        signalPlotDiv.on('plotly_click', (data) => {
            const clickedTimestamp = data.points[0].x;  // Get the clicked timestamp
            const videoTime = (clickedTimestamp - videoStartTimestamp) / 1000;  // Convert to seconds
            videoElement.currentTime = videoTime;  // Seek video to this time
        });

    </script>
</body>
</html>
